# Implementation Plan: Authentication System and JWT Integration

**Branch**: `003-better-auth-jwt` | **Date**: 2026-01-16 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-better-auth-jwt/spec.md`

**Note**: This plan was generated by the `/sp.plan` command.

## Summary

This feature implements JWT-based authentication for the multi-user Todo application. The backend (FastAPI) validates JWT tokens on protected endpoints, extracts the authenticated user_id, and enforces strict user isolation at the database query level. The frontend (Next.js) manages user sign-up, sign-in, and token storage, automatically including tokens in API requests. Both services share a common `BETTER_AUTH_SECRET` for cross-service token verification, ensuring tokens generated during authentication can be validated by backend middleware.

**Key Technical Decisions** (from research):
- Custom JWT implementation using python-jose (backend) and native parsing (frontend)
- Single shared `BETTER_AUTH_SECRET` environment variable
- localStorage for token storage (XSS mitigated by React)
- User isolation via UserIsolationService with query-level WHERE clauses
- 404 (not 403) for non-owned resource access to prevent enumeration attacks

## Technical Context

**Language/Version**: Python 3.11+ (Backend), TypeScript/JavaScript (Frontend)
**Primary Dependencies**: FastAPI, SQLModel, python-jose, passlib, Next.js 16+, React
**Storage**: Neon Serverless PostgreSQL (cloud-hosted, serverless)
**Testing**: pytest with pytest-asyncio (backend), Jest/Testing Library (frontend)
**Target Platform**: Cross-platform web application (Linux server + modern browsers)
**Project Type**: Web application (frontend + backend separation)
**Performance Goals**: Auth operations <100ms, token validation <10ms per request
**Constraints**: Token expiration 24 hours, minimum 32-char secret, HTTPS in production
**Scale/Scope**: Hundreds of users, thousands of todos per user

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### âœ… Gate 1: Spec-Driven Excellence
**Status**: PASS
**Evidence**: Feature specification exists at `/specs/003-better-auth-jwt/spec.md` with 3 user stories, 12 functional requirements, and 7 success criteria. All implementation decisions traceable to spec artifacts.

### âœ… Gate 2: Strict User Isolation (NON-NEGOTIABLE)
**Status**: PASS
**Evidence**: Spec explicitly requires:
- FR-003: All database queries filtered by authenticated user_id
- FR-010: Every protected endpoint implements user_id filtering
- FR-011: 404 (not 403) for non-owned resources
- SC-003: Enumeration attacks prevented

**Implementation**: UserIsolationService pattern already in codebase (`backend/src/services/user_isolation_example.py`)

### âœ… Gate 3: Modern Architecture
**Status**: PASS
**Evidence**: Full separation of concerns:
- Backend: FastAPI with SQLModel ORM, JWT middleware, Neon PostgreSQL
- Frontend: Next.js with TypeScript, Better Auth patterns
- RESTful API contracts defined in `/specs/003-better-auth-jwt/contracts/auth-api.yaml`
- CORS properly configured in `backend/src/main.py`

### âœ… Gate 4: Type Safety & Code Quality
**Status**: PASS
**Evidence**:
- Backend: Python type hints throughout (jwt_utils.py, auth_middleware.py, models/)
- Frontend: TypeScript strict mode, typed interfaces (auth-config.ts, api-client.ts)
- Pydantic models for request/response validation (api/models.py)
- No `Any` types without explicit justification

### âœ… Gate 5: Authentication & Authorization
**Status**: PASS
**Evidence**: This feature IS the authentication implementation:
- JWT tokens with HS256 algorithm and shared secret
- Token claims: sub, user_id, email, iat, exp
- Middleware extracts user_id for route handlers
- 24-hour token expiration (configurable)

### âœ… Gate 6: Testing & Validation
**Status**: PASS (Planned)
**Evidence**: Spec includes comprehensive acceptance scenarios:
- 5 scenarios per user story = 15 total acceptance tests
- Test files already exist: `test_auth_middleware.py`, `test_cross_service_validation.py`
- User isolation tests mandatory per constitution

## Project Structure

### Documentation (this feature)

```text
specs/003-better-auth-jwt/
â”œâ”€â”€ plan.md              # This file (/sp.plan command output)
â”œâ”€â”€ research.md          # Phase 0 output - technology decisions
â”œâ”€â”€ data-model.md        # Phase 1 output - entity definitions
â”œâ”€â”€ quickstart.md        # Phase 1 output - setup guide
â”œâ”€â”€ contracts/           # Phase 1 output
â”‚   â””â”€â”€ auth-api.yaml    # OpenAPI specification
â””â”€â”€ tasks.md             # Phase 2 output (/sp.tasks command)
```

### Source Code (repository root)

```text
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.py                  # FastAPI application
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ auth.py              # Authentication endpoints (/auth/register, /login, /me)
â”‚   â”‚   â””â”€â”€ models.py            # Pydantic request/response models
â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”œâ”€â”€ auth_middleware.py   # JWT verification, user_id extraction
â”‚   â”‚   â””â”€â”€ security.py          # Security headers
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â””â”€â”€ jwt_utils.py         # Token creation/verification utilities
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ auth_service.py      # Authentication business logic
â”‚   â”‚   â””â”€â”€ user_isolation_example.py  # User isolation patterns
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ user.py              # User SQLModel definition
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ settings.py          # Environment configuration
â”‚   â”‚   â””â”€â”€ auth_config.py       # Auth-specific configuration
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â””â”€â”€ connection.py        # Database connection setup
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ logger.py            # Security logging
â”‚       â””â”€â”€ rate_limiter.py      # Rate limiting for auth endpoints
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_auth_middleware.py  # Middleware unit tests
â”‚   â””â”€â”€ test_cross_service_validation.py  # Integration tests
â”œâ”€â”€ .env.example                 # Template for environment variables
â””â”€â”€ requirements.txt             # Python dependencies

frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â”œâ”€â”€ sign-in/page.tsx  # Sign-in page
â”‚   â”‚       â””â”€â”€ sign-up/page.tsx  # Sign-up page
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ auth/
â”‚   â”‚       â”œâ”€â”€ SignInForm.tsx    # Sign-in form component
â”‚   â”‚       â””â”€â”€ SignUpForm.tsx    # Sign-up form component
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ api-client.ts         # API client with auto-token injection
â”‚   â”‚   â”œâ”€â”€ auth-utils.ts         # Authentication utilities
â”‚   â”‚   â””â”€â”€ token-utils.ts        # Token management utilities
â”‚   â””â”€â”€ auth/
â”‚       â””â”€â”€ auth-config.ts        # Auth configuration and token storage
â””â”€â”€ .env.local.example            # Template for frontend env variables
```

**Structure Decision**: Web application structure selected based on constitution requirement (Principle III: Modern Architecture) for frontend/backend separation. The codebase already follows this structure from previous features.

## Complexity Tracking

> **No violations detected.** All constitution gates pass:

| Check | Status | Notes |
|-------|--------|-------|
| Spec-driven | âœ… | Full specification with user stories and acceptance criteria |
| User isolation | âœ… | Query-level enforcement via UserIsolationService |
| Modern architecture | âœ… | FastAPI + Next.js with RESTful contracts |
| Type safety | âœ… | Python hints + TypeScript strict mode |
| Authentication | âœ… | JWT with shared secret implementation |
| Testing | âœ… | Comprehensive test scenarios defined |

---

## Post-Design Constitution Re-evaluation

*Re-checked after Phase 0 (Research) and Phase 1 (Design) completion*

### âœ… Gate 1: Spec-Driven Excellence
**Status**: PASS âœ“
**Post-Design Evidence**:
- `research.md` documents 7 research areas with decisions, rationale, and alternatives
- `data-model.md` provides complete entity definitions with validation rules
- `quickstart.md` provides step-by-step setup instructions
- `contracts/auth-api.yaml` defines OpenAPI 3.0 specification with all endpoints
- All design artifacts traceable to functional requirements in `spec.md`

### âœ… Gate 2: Strict User Isolation (NON-NEGOTIABLE)
**Status**: PASS âœ“
**Post-Design Evidence**:
- UserIsolationService pattern documented in `research.md:116-149`
- Query-level WHERE clause enforcement in `data-model.md:133-140`
- 404 response for non-owned resources in `contracts/auth-api.yaml:468-474`
- Integration test requirements defined in `data-model.md:349-357`

### âœ… Gate 3: Modern Architecture
**Status**: PASS âœ“
**Post-Design Evidence**:
- Full frontend/backend separation documented in `quickstart.md:116-160`
- RESTful API contracts in OpenAPI format
- Environment-based configuration pattern established
- CORS and security headers configured

### âœ… Gate 4: Type Safety & Code Quality
**Status**: PASS âœ“
**Post-Design Evidence**:
- Python type hints for all functions in existing codebase
- TypeScript interfaces defined in `data-model.md:193-230`
- Pydantic request/response models in `data-model.md:144-189`
- No `Any` types in model definitions

### âœ… Gate 5: Authentication & Authorization
**Status**: PASS âœ“
**Post-Design Evidence**:
- JWT claims structure defined in `data-model.md:69-109`
- Token lifecycle documented: creation, verification, expiration
- Shared secret strategy in `research.md:44-80`
- Password hashing with bcrypt documented

### âœ… Gate 6: Testing & Validation
**Status**: PASS âœ“
**Post-Design Evidence**:
- Unit tests defined in `data-model.md:341-346`
- Integration tests defined in `data-model.md:348-352`
- Security tests defined in `data-model.md:354-357`
- Test scenarios map to acceptance criteria in spec

### ðŸ“‹ Architectural Decisions Requiring Documentation

Based on the three-part test (Impact + Alternatives + Scope), the following significant architectural decisions have been made:

1. **Custom JWT Implementation vs Better Auth Sessions** (meets all criteria)
   - **Impact**: Determines session management strategy for entire application
   - **Alternatives**: Pure Better Auth sessions, third-party auth services
   - **Scope**: Cross-cutting decision affecting frontend token handling and backend middleware
   - **Documented in**: `research.md:13-40`

2. **Shared Secret (HS256) vs Asymmetric Keys (RS256)** (meets all criteria)
   - **Impact**: Cryptographic foundation for cross-service authentication
   - **Alternatives**: RS256/ES256 asymmetric signing, service-to-service tokens
   - **Scope**: Affects deployment, key management, and security posture
   - **Documented in**: `research.md:44-80`

3. **localStorage vs HttpOnly Cookies for Token Storage** (meets all criteria)
   - **Impact**: Client-side security model and CSRF/XSS trade-offs
   - **Alternatives**: sessionStorage, memory-only, HttpOnly cookies
   - **Scope**: Affects frontend security architecture and API communication
   - **Documented in**: `research.md:192-222`

**Recommendation**: Consider documenting these decisions formally via `/sp.adr` command:
- ðŸ“‹ `/sp.adr custom-jwt-vs-better-auth-sessions` - Document session strategy choice
- ðŸ“‹ `/sp.adr symmetric-jwt-signing-hs256` - Document cryptographic approach
- ðŸ“‹ `/sp.adr localstorage-token-storage` - Document client-side storage trade-offs

### Final Verdict

**ALL CONSTITUTION GATES PASS** âœ…

The authentication system and JWT integration design fully complies with all six constitutional principles:
1. âœ… Spec-driven with complete documentation artifacts
2. âœ… User isolation enforced at query level with 404 responses
3. âœ… Modern web architecture with separated frontend/backend
4. âœ… Full type safety via Python hints and TypeScript
5. âœ… JWT authentication with shared secret implementation
6. âœ… Comprehensive testing strategy defined

**No complexity violations or trade-offs requiring justification.**

**Implementation is cleared to proceed to Phase 2: Task Generation** (`/sp.tasks` command)
