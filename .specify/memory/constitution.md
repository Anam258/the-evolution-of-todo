# Todo Evolution Phase 2 - Multi-User Web App Constitution

<!--
Sync Impact Report:
- Version change: [UNVERSIONED] â†’ 1.0.0
- Rationale: Initial constitution ratification for Phase 2 (multi-user web app)
- Modified principles: N/A (new constitution)
- Added sections: All sections (new)
- Removed sections: N/A
- Templates requiring updates:
  âœ… plan-template.md: Constitution Check section compatible (gates determined from principles)
  âœ… spec-template.md: Requirements and user story structure aligns with functional requirements and success criteria principles
  âœ… tasks-template.md: Task organization supports spec-driven, user-isolated, and testable implementation approach
- Follow-up TODOs: None
-->

## Core Principles

### I. Spec-Driven Excellence

**MUST**: All code generated by Claude Code via Spec-Kit Plus workflow. No manual coding.

**Rationale**: Ensures reproducibility, traceability, and architectural consistency. Every implementation decision must be traceable back to a markdown specification in the specs/ directory, enabling audit, review, and rollback capabilities.

**Implementation**:
- All features originate from `/specs/<feature>/spec.md`
- Planning artifacts in `/specs/<feature>/plan.md` before implementation
- Task breakdowns in `/specs/<feature>/tasks.md` guide execution
- Prompt History Records (PHRs) capture all user interactions

### II. Strict User Isolation (NON-NEGOTIABLE)

**MUST**: No user can ever access or modify another user's data. Every API route MUST validate ownership via `user_id` extracted from JWT.

**Rationale**: Security violation of user isolation is catastrophic and non-recoverable. This is the highest-priority architectural constraint.

**Implementation**:
- All database queries scoped by `user_id` from JWT
- FastAPI middleware validates JWT on protected routes
- 401 Unauthorized for invalid/missing tokens
- 404 Not Found for valid tokens accessing non-owned resources (prevents enumeration)
- User isolation tests mandatory for all data access endpoints

### III. Modern Architecture

**MUST**: Full separation of concerns between Next.js (Frontend) and FastAPI (Backend).

**Rationale**: Enables independent scaling, testing, and deployment. Frontend and backend teams can work in parallel with clear API contracts.

**Implementation**:
- **Backend**: FastAPI with SQLModel ORM, Neon Serverless PostgreSQL
- **Frontend**: Next.js 16+ with TypeScript, Better Auth for authentication
- RESTful API contracts defined in `/specs/<feature>/contracts/`
- CORS properly configured for frontend-backend communication
- Environment-based configuration (development, staging, production)

### IV. Type Safety & Code Quality

**MUST**: Typed Python (Type Hints) for backend, TypeScript for frontend. All code must pass type checking before commit.

**Rationale**: Type safety catches bugs at development time, improves IDE support, and serves as inline documentation.

**Implementation**:
- Backend: Python type hints for all function signatures, SQLModel for database models
- Frontend: TypeScript strict mode, typed component props
- Linters: ruff (Python), ESLint (TypeScript)
- Pre-commit hooks: type checking, linting, formatting
- No `Any` types without explicit justification

### V. Authentication & Authorization

**MUST**: Better Auth with JWT plugin for cross-service verification. Shared `BETTER_AUTH_SECRET` for signing/verification.

**Rationale**: Standardized authentication ensures consistent security posture across frontend and backend.

**Implementation**:
- Better Auth configured on Next.js frontend
- JWT signed with `BETTER_AUTH_SECRET` environment variable
- FastAPI middleware verifies JWT using same secret
- JWT contains `user_id` claim for authorization
- Token expiration and refresh handled by Better Auth
- Sessions persisted in database (Neon PostgreSQL)

### VI. Testing & Validation

**MUST**: All user-facing features tested. User isolation must be verified with integration tests.

**Rationale**: User isolation bugs are catastrophic; automated tests prevent regression.

**Implementation**:
- Contract tests for API endpoints (expected inputs/outputs)
- Integration tests for user isolation (verify users cannot access other users' data)
- Frontend component tests for critical user flows
- Test data setup with multiple test users
- CI/CD pipeline blocks merge on test failure

## Technical Standards

### Database

- **Platform**: Neon Serverless PostgreSQL
- **ORM**: SQLModel (Pydantic + SQLAlchemy)
- **Migrations**: Alembic (automatic from SQLModel changes)
- **Connection Pooling**: Configured for serverless (handle cold starts)
- **Schema**: All tables include `user_id` foreign key for user isolation
- **Indexing**: Index on `user_id` for all user-scoped queries

### API Design

- **Protocol**: RESTful over HTTPS
- **Format**: JSON request/response bodies
- **Versioning**: URL-based (`/api/v1/...`) when breaking changes required
- **Error Codes**:
  - `200 OK`: Success
  - `201 Created`: Resource created
  - `400 Bad Request`: Invalid input
  - `401 Unauthorized`: Missing/invalid authentication
  - `403 Forbidden`: Authenticated but insufficient permissions
  - `404 Not Found`: Resource not found OR not owned by user (prevents enumeration)
  - `422 Unprocessable Entity`: Validation error with details
  - `500 Internal Server Error`: Server failure
- **Response Structure**:
  ```json
  {
    "data": { ... },
    "error": { "code": "...", "message": "..." }
  }
  ```

### Code Organization

- **Backend** (`backend/`):
  - `src/models/`: SQLModel database models
  - `src/services/`: Business logic layer
  - `src/api/`: FastAPI route handlers
  - `src/middleware/`: Authentication, CORS, error handling
  - `tests/`: Contract, integration, unit tests

- **Frontend** (`frontend/`):
  - `src/app/`: Next.js App Router pages
  - `src/components/`: React components
  - `src/lib/`: Utilities and API client
  - `src/auth/`: Better Auth configuration
  - `tests/`: Component and integration tests

## Security Requirements

### Environment Variables

- **NEVER** commit secrets to repository
- **ALWAYS** use `.env.local` (gitignored) for local development
- **REQUIRED** variables:
  - `BETTER_AUTH_SECRET`: Shared secret for JWT signing (minimum 32 characters)
  - `DATABASE_URL`: Neon PostgreSQL connection string
  - `NEXT_PUBLIC_API_URL`: Backend API URL for frontend

### Input Validation

- **Backend**: Pydantic models validate all request bodies
- **Frontend**: Form validation before submission
- **SQL Injection**: Prevented by SQLModel parameterized queries (never string concatenation)
- **XSS**: React escapes output by default, use `dangerouslySetInnerHTML` only with sanitization

### CORS Configuration

- Development: Allow `localhost:3000` (frontend)
- Production: Whitelist only production frontend domain
- Credentials: `allow_credentials=True` for JWT cookies

## Development Workflow

### Feature Implementation Lifecycle

1. **Specification**: User describes feature â†’ `/sp.specify` generates `spec.md`
2. **Planning**: `/sp.plan` creates `plan.md` with architecture decisions
3. **Task Breakdown**: `/sp.tasks` generates `tasks.md` with ordered, testable tasks
4. **Implementation**: `/sp.implement` executes tasks, creating PHRs for each step
5. **Commit & PR**: `/sp.git.commit_pr` creates commit and pull request

### Prompt History Records (PHRs)

**MUST** create PHR after every user interaction requiring code changes or architectural decisions.

- **Routing** (all under `history/prompts/`):
  - Constitution â†’ `history/prompts/constitution/`
  - Feature-specific â†’ `history/prompts/<feature-name>/`
  - General â†’ `history/prompts/general/`
- **Format**: `<ID>-<slug>.<stage>.prompt.md`
- **Content**: Full user input (verbatim), assistant response (concise), files changed, tests run

### Architecture Decision Records (ADRs)

**Suggest** (never auto-create) ADR when architecturally significant decision detected:

ðŸ“‹ Architectural decision detected: [brief description] â€” Document reasoning and tradeoffs? Run `/sp.adr <decision-title>`

**Significance Test** (ALL must be true):
- **Impact**: Long-term consequences (framework, data model, API, security, platform)
- **Alternatives**: Multiple viable options considered
- **Scope**: Cross-cutting and influences system design

## Governance

### Amendment Process

1. Propose changes via pull request to `.specify/memory/constitution.md`
2. Update version number (semantic versioning):
   - **MAJOR**: Backward incompatible principle removals/redefinitions
   - **MINOR**: New principle or materially expanded guidance
   - **PATCH**: Clarifications, wording fixes, non-semantic refinements
3. Update dependent templates (plan, spec, tasks) for consistency
4. Create Sync Impact Report (prepend as HTML comment)
5. Require review from project maintainer
6. Update `LAST_AMENDED_DATE` on approval

### Compliance

- All pull requests must reference constitution principles
- Code reviews verify adherence to type safety, user isolation, and testing requirements
- CI/CD pipeline enforces linting, type checking, and test coverage
- Complexity additions require explicit justification against simplicity principle

### Version History

**Version**: 1.0.0 | **Ratified**: 2026-01-12 | **Last Amended**: 2026-01-12
